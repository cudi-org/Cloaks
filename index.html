<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://cdn.jsdelivr.net wss://cloaks-signalin.onrender.com ws://localhost:8080; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; media-src 'self' blob: data:; object-src 'self' blob: data:; frame-src 'self' blob: data:; worker-src 'self' blob:;">
  <title>Cloaks - P2P Community</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/x-icon" href="./icons/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="./css/styles.css" />
</head>

<body>
  <div id="app-container" class="app-shell">
    <!-- 1. Server Rail (Cloaks list) -->
    <nav class="server-rail">
      <div class="server-icon home-icon active" id="btn-home" title="Home">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
          <path d="M12 3L4 9v12h5v-7h6v7h5V9z" />
        </svg>
      </div>
      <div class="rail-divider"></div>
      <div id="server-list">
        <!-- Loaded Cloaks will appear here as icons -->
      </div>
      <div class="server-icon add-server" id="tabCommunity" title="Enter Community">
        <span>+</span>
      </div>
    </nav>

    <!-- 2. Middle Column: Channels & User Info -->
    <aside class="channel-sidebar">
      <header class="sidebar-header">
        <h3 id="community-name-display">Cloaks</h3>
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M7 10l5 5 5-5z" />
        </svg>
      </header>

      <div class="channel-scroller" id="channel-list">
        <!-- Dynamic channels -->
        <div id="menu-context-msg" class="empty-state-msg">
          Load a Cloak to see channels
        </div>
      </div>

      <div class="user-panel">
        <div class="user-avatar-wrapper">
          <img id="user-avatar-small" src="./icons/logo.png" alt="Profile" class="avatar-small">
          <span id="user-status-dot" class="status-dot ghost"></span>
        </div>
        <div class="user-details">
          <span id="user-name-small">Anonymous</span>
          <span id="user-tag-small">#0000</span>
        </div>
        <div class="user-actions">
          <button id="zero-trace-btn" class="icon-btn-minimal" title="Zero-Trace Mode">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path
                d="M12 2C6.47 2 2 6.47 2 12s4.47 10 9.03 10c.53 0 1.05-.04 1.56-.13.38-.07.6-.47.47-.84-.13-.37-.53-.55-.91-.49-.37.06-.74.09-1.12.09-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8c0 .38-.03.75-.09 1.12-.06.38.12.78.49.91.37.13.77-.09.84-.47.09-.51.13-1.03.13-1.56C22 6.47 17.53 2 12 2z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
          </button>
          <button id="settings-btn" class="icon-btn-minimal" title="Settings">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path
                d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- 3. Main Chat Area -->
    <main class="chat-main">
      <header class="chat-header">
        <div class="header-left">
          <span class="hash">#</span>
          <div class="header-titles">
            <span id="current-channel-name">welcome</span>
            <div id="header-peer-info" class="header-peer-activity hidden">
              <span id="peer-pronouns" style="opacity: 0.6; font-size: 10px;"></span>
              <span id="peer-spotify" class="spotify-status"></span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <button id="btnStartVideo" class="header-icon-btn" title="Start Call">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path
                d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
            </svg>
          </button>
          <div class="search-bar">
            <input type="text" placeholder="Search">
          </div>
          <button id="help-btn" class="header-icon-btn">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
            </svg>
          </button>
        </div>
      </header>

      <section id="chat-scroller" class="messages-area">
        <!-- Welcome screen in chat -->
        <div id="welcome-screen" class="welcome-container">
          <div class="welcome-hero-banner">
            <div class="hero-overlay-gradient"></div>
            <img src="./icons/logo-removebg-preview.png" alt="Cloaks Logo" class="hero-logo-large">
          </div>

          <div class="welcome-content-wrap">
            <h2 class="section-title">CLOAKS P2P</h2>
            <p class="hero-text">The next generation of sovereign communications.</p>

            <div id="menu" class="onboarding-menu">
              <p class="menu-intro-text">What would you like to do today?</p>
              <div class="action-cards">
                <div class="action-card" id="tabSend">
                  <h4>Send Directly</h4>
                  <p>Fast P2P file transfer</p>
                </div>
                <div class="action-card" id="tabReceive">
                  <h4>Receive File</h4>
                  <p>Join with a room code</p>
                </div>
                <div class="action-card" id="btnCreateCommunity">
                  <h4>Create Cloak</h4>
                  <p>Setup a private community</p>
                </div>
              </div>

              <!-- Room Inputs (Hidden initially) -->
              <div id="send-controls" class="entry-controls hidden">
                <input type="text" id="aliasInput" placeholder="Your Alias" class="discord-input">
                <input type="text" id="customRoomInput" placeholder="Room Code (Opt)" class="discord-input">
                <input type="password" id="roomPasswordInput" placeholder="Room Password (Opt)" class="discord-input">
                <button id="btnCreate" class="discord-btn-primary">Start Room</button>
              </div>

              <div id="recepcion" class="entry-controls hidden">
                <input type="text" id="codigoSala" placeholder="Enter Room Code" class="discord-input">
                <input type="password" id="joinPasswordInput" placeholder="Room Password (if locked)"
                  class="discord-input">
                <button id="unirseBtn" class="discord-btn-primary">Join Room</button>
              </div>
            </div> <!-- End onboarding-menu -->
          </div> <!-- End welcome-content-wrap -->
        </div> <!-- End welcome-screen -->

        <div id="zonaTransferencia" class="hidden">
          <!-- Video, Status, etc. (Discord-like overlay) -->
          <div id="videoContainer" class="video-overlay hidden">
            <div class="video-wrapper">
              <video id="remoteVideo" autoplay playsinline></video>
              <video id="localVideo" autoplay playsinline muted class="self-video"></video>
              <div class="video-controls-discord">
                <button id="btnToggleAudio" class="ctrl-btn">üé§</button>
                <button id="btnToggleVideo" class="ctrl-btn">üìπ</button>
                <button id="btnStopVideo" class="ctrl-btn hangup">üìû</button>
              </div>
            </div>
          </div>

          <div id="dropZone" class="discord-dropzone">
            <p>Drag files to transfer</p>
            <input type="file" id="fileInput" hidden />
          </div>

          <div id="salaStatusContainer" class="room-info-pill">
            <span id="salaStatus">No active room</span>
            <div class="room-actions-group">
              <button id="copy-link-btn" class="icon-btn-minimal" title="Copy Link">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                  <path
                    d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" />
                </svg>
              </button>
              <button id="toggle-qr-btn" class="icon-btn-minimal" title="Show QR Code">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                  <path
                    d="M15 21h-2v-2h2v2zm4-12h-2V7h2v2zM3 3v8h8V3H3zm6 6H5V5h4v4zm-6 4v8h8v-8H3zm6 6H5v-4h4v4zm12-16v8h-8V3h8zm-2 6h-4V5h4v4zM13 13h2v2h-2v-2zm2 2h2v2h-2v-2zm-2 2h2v2h-2v-2zm2-2h2v-2h-2v2zm2 2h2v-2h-2v2zM13 15v2h2v-2h-2z" />
                </svg>
              </button>
            </div>
          </div>

          <div id="qrContainer" class="qr-pill hidden"></div>
        </div>

        <div id="messagesDisplay" class="message-list hidden">
          <!-- Real messages here -->
        </div>
      </section>

      <footer class="chat-input-area">
        <div class="input-wrapper">
          <button class="attach-btn">+</button>
          <input type="text" id="chatInput" placeholder="Message #welcome" disabled>
          <button id="sendChatBtn" class="send-btn" disabled>
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          </button>
        </div>
      </footer>
    </main>

    <!-- 4. Right Column: Members & Presence -->
    <aside class="member-sidebar">
      <div class="member-group">
        <h4>PEERS ‚Äî <span id="peer-count">0</span></h4>
        <div id="member-list">
          <!-- Peer items -->
        </div>
      </div>
    </aside>
  </div>

  <footer>
    <p>
      &copy; 2026 CUDI - Comunidad de Usuarios para la Defensa Inform√°tica | <a href="#" id="open-legal-modal"
        class="text-inherit">Legal Notice</a>
    </p>
  </footer>

  <div id="toast-container"></div>
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p id="loading-message">Loading...</p>
  </div>

  <!-- Technical Protocol Specs Modal -->
  <div id="info-modal" class="modal hidden">
    <div class="specs-view glass">
      <span id="close-modal" class="close-specs">&times;</span>
      <div class="specs-header">
        <label>SYSTEM PROTOCOL</label>
        <h3>CLOAK CORE SPECIFICATIONS</h3>
      </div>

      <div class="specs-scroller">
        <!-- 1. Handshake -->
        <div class="spec-section">
          <div class="spec-num">01</div>
          <div class="spec-content">
            <h4>DIRECT HANDSHAKE</h4>
            <p>Connections originate from a direct trust exchange via encrypted URLs containing temporary public keys.
              No central registry is consulted.</p>
          </div>
        </div>

        <!-- 2. Serverless -->
        <div class="spec-section">
          <div class="spec-num">02</div>
          <div class="spec-content">
            <h4>SERVERLESS ARCHITECTURE</h4>
            <p>Once established, messages flow through <strong>WebRTC Data Channels</strong>. "Sent" and "Received"
              status are P2P signals, not database updates.</p>
          </div>
        </div>

        <!-- 3. OPFS Persistence -->
        <div class="spec-section">
          <div class="spec-num">03</div>
          <div class="spec-content">
            <h4>OPFS LOCAL SILOS</h4>
            <p>All interactions are indexed in your <strong>Origin Private File System</strong>. Your browser reads your
              local disk to reload history instantly.</p>
          </div>
        </div>

        <!-- 4. Peer Caching -->
        <div class="spec-section">
          <div class="spec-num">04</div>
          <div class="spec-content">
            <h4>PEER CACHING & SURVIVABILITY</h4>
            <p>The system caches last known public IPs to attempt direct reconnections, ensuring communication even if
              the main gateway goes offline.</p>
          </div>
        </div>

        <!-- 5. Social Mode -->
        <div class="spec-section">
          <div class="spec-num">05</div>
          <div class="spec-content">
            <h4>IDENTITY UNDER DEMAND</h4>
            <p>Profiles are partitioned. Your avatar and metadata are only transmitted if your <strong>Social
                Mode</strong> is explicitly active for that peer.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Legal Disclaimer Modal -->
  <div id="legal-modal" class="modal hidden">
    <div class="legal-view glass">
      <div class="legal-header">
        <div class="security-shield-icon">üõ°Ô∏è</div>
        <h3>SOVEREIGNTY AGREEMENT</h3>
        <p class="subtitle">Security Protocols & P2P Terms</p>
      </div>

      <div class="legal-body">
        <div class="disclaimer-grid">
          <div class="disclaimer-item">
            <div class="disc-text">
              <label>Direct Transmission</label>
              <p>Data flows exclusively between peers. No cloud storage is involved in this process.</p>
            </div>
          </div>
          <div class="disclaimer-item">
            <div class="disc-text">
              <label>End-to-End Cryptography</label>
              <p>All transfers are encrypted locally before leaving your device silo.</p>
            </div>
          </div>
        </div>

        <div class="responsibility-box">
          <label>OPERATOR RESPONSIBILITY</label>
          <p>By initializing this protocol, you acknowledge full legal and ethical responsibility for the data packets
            transmitted. Cloaks is a neutral conduit for sovereign communication.</p>
        </div>
      </div>

      <div class="legal-footer">
        <button id="legal-accept-btn" class="discord-btn-primary">INITIALIZE PROTOCOL</button>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal hidden">
    <div class="settings-view glass">
      <!-- Settings Sidebar -->
      <aside class="settings-sidebar">
        <div class="sidebar-section">
          <small>USER SETTINGS</small>
          <div class="settings-tab active" data-target="section-profile">Profiles</div>
          <div class="settings-tab" data-target="section-account">My Account</div>
          <div class="settings-tab" data-target="section-privacy">Privacy & Safety</div>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-section">
          <small>APP SETTINGS</small>
          <div class="settings-tab" data-target="section-advanced">Advanced</div>
          <div class="settings-tab btn-danger" id="panic-btn-modal">PANIC (Clear All)</div>
        </div>
      </aside>

      <!-- Settings Content -->
      <main class="settings-content-area">
        <div class="content-scroller">

          <!-- Section: Profiles -->
          <section id="section-profile" class="settings-section">
            <h2>Profiles</h2>
            <div class="profile-redesign">
              <div class="profile-config">
                <label class="setting-item-label">User Profile</label>
                <div class="profile-inputs-discord">
                  <div class="input-field">
                    <label>DISPLAY NAME</label>
                    <input type="text" id="profile-name" placeholder="Anonymous">
                  </div>
                  <div class="input-field">
                    <label>PRONOUNS</label>
                    <input type="text" id="profile-pronouns" placeholder="he/him">
                  </div>
                  <button id="change-avatar-btn" class="discord-btn-primary">Change Avatar</button>
                  <input type="file" id="profile-photo-input" hidden accept="image/*">
                </div>
              </div>

              <!-- Live Preview Card -->
              <div class="profile-preview">
                <label class="setting-item-label">PREVIEW</label>
                <div class="discord-card-preview" id="profile-card-preview-bg">
                  <div class="banner-color"></div>
                  <div class="preview-avatar-wrap">
                    <img id="profile-avatar-preview" src="./icons/logo.png" alt="Avatar">
                    <div class="preview-status-dot social"></div>
                  </div>
                  <div class="preview-info-box">
                    <div class="preview-name-wrap">
                      <span id="preview-name-val">Anonymous</span>
                      <span id="preview-tag-val">#0000</span>
                    </div>
                    <div class="preview-pronouns" id="preview-pronouns-val">he/him</div>
                    <div class="preview-divider"></div>
                    <div class="preview-section">
                      <label>CLOAK MEMBER SINCE</label>
                      <span>Feb 2026</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Section: My Account (Presence) -->
          <section id="section-account" class="settings-section hidden">
            <h2>My Account</h2>
            <div class="settings-group-modern">
              <label>PRESENCE SETTINGS</label>
              <div class="setting-card">
                <div class="card-row">
                  <div class="row-info">
                    <h4>Spotify Integration</h4>
                    <p>Show your friends what you are listening to.</p>
                  </div>
                  <input type="password" id="spotify-token" placeholder="Refresh Token" class="discord-input-subtle">
                </div>
                <div class="card-row">
                  <div class="row-info">
                    <h4>Game Activity</h4>
                    <p>Custom status shown in the member list.</p>
                  </div>
                  <input type="text" id="game-activity" placeholder="e.g. In The Matrix" class="discord-input-subtle">
                </div>
              </div>
            </div>
          </section>

          <!-- Section: Privacy -->
          <section id="section-privacy" class="settings-section hidden">
            <h2>Privacy & Safety</h2>
            <div class="settings-group-modern">
              <div class="setting-card">
                <div class="card-row">
                  <div class="row-info">
                    <h4 id="privacy-mode-label">Social Mode</h4>
                    <p>Allow others to see your profile and presence.</p>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="privacy-toggle" checked>
                    <span class="slider round"></span>
                  </label>
                </div>
                <div class="card-row">
                  <button id="export-identity-btn" class="discord-btn-outline">Export Identity (JSON)</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Section: Advanced -->
          <section id="section-advanced" class="settings-section hidden">
            <h2>Advanced Settings</h2>
            <div class="settings-group-modern">
              <div class="setting-card">
                <div class="card-row-vertical">
                  <label>STUN SERVER</label>
                  <select id="stun-select" class="discord-select">
                    <option value="google">Google (Default) - Max Speed</option>
                    <option value="cloudflare">Cloudflare - Speed & Privacy</option>
                    <option value="mozilla">Mozilla - Privacy Focused</option>
                    <option value="twilio">Twilio - Reliability</option>
                    <option value="none">None - Local Network Only</option>
                    <option value="custom">Custom (Manual)</option>
                  </select>
                  <input type="text" id="custom-stun-input" placeholder="stun:your.server.com:3478"
                    class="discord-input-subtle mt-10 hidden">
                </div>
                <div class="card-row-vertical mt-20">
                  <label>FILE SIZE LIMIT</label>
                  <select id="filesize-select" class="discord-select">
                    <option value="0">No Limit</option>
                    <option value="10">10 MB</option>
                    <option value="50">50 MB</option>
                    <option value="100">100 MB</option>
                    <option value="500">500 MB</option>
                    <option value="1024">1 GB</option>
                  </select>
                </div>
              </div>
            </div>
          </section>

        </div>
        <button id="close-settings-modal" class="settings-close-btn">&times;</button>
        <div class="settings-save-bar" id="settings-save-bar">
          <span>Careful ‚Äî you have unsaved changes!</span>
          <div class="save-bar-actions">
            <button id="reset-settings-btn" class="btn-link">Reset</button>
            <button id="save-settings-btn" class="discord-btn-success">Save Changes</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"
    integrity="sha384-Dr98ddmUw2QkdCarNQ+OL7xLty7cSxgR0T7v1tq4UErS/qLV0132sBYTolRAFuOV"
    crossorigin="anonymous"></script>
  <script src="./js/config.js"></script>
  <!-- Application Scripts (Non-Module for file:// support) -->
  <script src="js/dictionary.js"></script>
  <script src="js/state.js"></script>
  <script src="js/opfs.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/cptp.js"></script>
  <script src="js/file-transfer.js"></script>
  <script src="js/signaling.js"></script>
  <script src="js/webrtc.js"></script>
  <script src="js/community.js"></script>
  <script src="js/presence.js"></script>
  <script src="js/identity.js"></script>
  <script src="js/main.js" defer></script>
</body>

</html>